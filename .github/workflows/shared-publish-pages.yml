name: Reusable - Publish Allure to GitHub Pages

on:
  workflow_call:
    inputs:
      retention_days:
        required: true
        type: number
      publish_branches_json:
        required: true
        type: string
      source_workflow_file:
        required: true
        type: string
      suite:
        required: true
        type: string

permissions:
  contents: read
  pages: write
  id-token: write

jobs:
  publish:
    name: Publish (GitHub Pages)
    runs-on: ubuntu-latest
    environment:
      name: github-pages
      url: ${{ steps.deploy.outputs.page_url }}

    steps:
      - name: Download Allure HTML artifact
        uses: actions/download-artifact@v4
        with:
          name: allure-report
          path: ./_site

      # Bring in last published site so older runs remain visible
      - name: Download previous site bundle
        uses: dawidd6/action-download-artifact@v3
        with:
          name: site-bundle
          path: _prev
          workflow: ${{ inputs.source_workflow_file }}
          workflow_conclusion: completed
          if_no_artifact_found: ignore

      # Stage per-run report and a SUITE+branch "latest" redirect, preserving old runs
      - name: Stage per-run report and latest redirect
        run: |
          set -euo pipefail
          
          SUITE="${{ inputs.suite }}"
          BRANCH="${{ github.ref_name }}"
          RUN="${{ github.run_number }}"
          
          # start with what's already live
          mkdir -p publish
          
          # Cleanup legacy structure (pre-suite layout) BEFORE merging previous site
          rm -rf publish/runs || true
          
          # bring in last published site so older runs remain visible
          if [ -d _prev ]; then cp -a _prev/. publish/; fi
          
          # prevent Jekyll processing
          touch publish/.nojekyll
          
          # suite + branch paths
          mkdir -p "publish/${SUITE}/${BRANCH}/${RUN}" "publish/${SUITE}/${BRANCH}/latest"
          
          # copy this run
          cp -a _site/. "publish/${SUITE}/${BRANCH}/${RUN}/"
          
          # redirect: <suite>/<branch>/latest -> <suite>/<branch>/<run>/
          cat > "publish/${SUITE}/${BRANCH}/latest/index.html" <<EOF
          <!doctype html>
          <meta charset="utf-8">
          <meta http-equiv="refresh" content="0; url=../${RUN}/">
          <title>Redirecting to latest run…</title>
          <h1>Redirecting to latest run…</h1>
          <p>If you're not redirected, <a href="../${RUN}/">open run ${RUN}</a>.</p>
          EOF


      # Landing page: Suites -> Branches -> latest
      - name: Build home index.html (suites → branches → latest)
        run: |
          set -euo pipefail

          cat > publish/index.html <<'HTML'
          <!doctype html>
          <meta charset="utf-8">
          <title>E2E Allure Reports</title>
          <h1>E2E Allure Reports</h1>
          <p>Select a suite and branch to view its latest report:</p>
          HTML

          # Build a simple suite list
          if [ -d publish ]; then
            for suite in $(ls -1 publish | grep -vE '^(index\.html|\.nojekyll|runs)$' || true); do
              # only include directories
              [ -d "publish/${suite}" ] || continue

              echo "<h2>${suite}</h2>" >> publish/index.html
              echo "<ul>" >> publish/index.html

              # list branches inside the suite
              for branch in $(ls -1 "publish/${suite}" | sort || true); do
                [ -d "publish/${suite}/${branch}" ] || continue
                echo "  <li><a href=\"${suite}/${branch}/latest/\">${branch} — latest</a></li>" >> publish/index.html
              done

              echo "</ul>" >> publish/index.html
            done
          fi

      - name: Setup Pages
        uses: actions/configure-pages@v5

      - name: Upload Pages artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./publish

      - name: Deploy to GitHub Pages
        id: deploy
        uses: actions/deploy-pages@v4

      - name: Archive site for next publish
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: site-bundle
          path: ./publish
          retention-days: ${{ inputs.retention_days }}

      - name: Publish summary with link
        run: |
          echo "### Allure report published" >> $GITHUB_STEP_SUMMARY
          echo "- Suite: \`${{ inputs.suite }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- Latest for \`${{ github.ref_name }}\`: ${{ steps.deploy.outputs.page_url }}${{ inputs.suite }}/${{ github.ref_name }}/latest/" >> $GITHUB_STEP_SUMMARY
          echo "- This run: ${{ steps.deploy.outputs.page_url }}${{ inputs.suite }}/${{ github.ref_name }}/${{ github.run_number }}/" >> $GITHUB_STEP_SUMMARY
